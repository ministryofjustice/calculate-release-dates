{% extends "../../partials/layout.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% set pageTitle = applicationName + " - calculation summary" %}
{% set pageId = "calculation-summary" %}

{% block aside %}
    {% set prisonerDetail = model.prisonerDetail %}
    {% include "../partials/prisonerIdentityBar.njk" %}
{% endblock %}

{% block beforeContent %}
    {{ super() }}
    <nav>
        {{ govukBackLink({
            text: "Back",
            href: "/calculation/" + model.prisonerDetail.offenderNo + "/check-information"
        }) }}
    </nav>
{% endblock %}

{% block content %}
    {% set validationErrors = model.validationErrors %}
    {% include "../partials/customErrorBanner.njk" %}
    {% include "../partials/ersedRecallNotificationBanner.njk" %}
    {% include "../partials/ersedCannotHappenNotificationBanner.njk" %}
    {% include "../partials/hdcedNotificationBanner.njk" %}
    <div class="moj-width-container govuk-!-margin-top-9">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">Review calculation</h1>
                {% if not model.approvedDates %}
                    <p class="govuk-body">Check the release dates before entering the approved dates.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <h2 class="govuk-heading-l govuk-!-margin-top-9">Release dates</h2>

            {% include "../partials/calculationSummaryDates.njk" %}
        </div>
    </div>
    {% if model.approvedDates %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-three-quarters">
                <h2 class="govuk-heading-l govuk-!-margin-top-9">Manual dates</h2>
                {% include "../partials/approvedSummaryDates.njk" %}
            </div>
        </div>
    {% endif %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {% include "../partials/calculationSummary/detailsMissingInset.njk" %}
            {% include "../partials/calculationSummary/howDatesCalculatedInset.njk" %}
        </div>
    </div>

    {% include "../partials/calculationSummaryBreakdown.njk" %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {% if featureToggles.approvedDates %}
                {% if not model.approvedDates %}
                    <h3 class="govuk-heading-m govuk-!-margin-top-9">Confirm the dates are correct</h3>
                    <p class="govuk-body">By continuing you are confirming that, to the best of your knowledge, the calculation is correct.</p>
                    {{ govukButton({
                        text: "Confirm and continue",
                        value: 'approved-dates-question',
                        preventDoubleClick: true,
                        href: "/calculation/" + model.prisonerDetail.offenderNo + "/" + model.calculationRequestId + "/approved-dates-question",
                        attributes: { 'data-qa': 'submit-to-nomis' }
                    }) }}
                {% else %}
                    <h3 class="govuk-heading-m govuk-!-margin-top-9">Confirm and save to NOMIS</h3>
                    <p class="govuk-body">By continuing, you are confirming that, to the best of your knowledge, the
                        information is correct. The calculation will be saved in NOMIS.</p>
                    <form method="post">
                        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>

                        {{ govukButton({
                            text: "Confirm and save to NOMIS",
                            value: 'save',
                            preventDoubleClick: true,
                            type: submit,
                            attributes: { 'data-qa': 'submit-to-nomis' }
                        }) }}
                    </form>
                {% endif %}
            {% else %}
                <p class="govuk-body">By submitting this calculation you are confirming that, to the best of your
                    knowledge,
                    it is correct. The calculation will be saved in NOMIS.</p>
                <form method="post">
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                    {{ govukButton({
                        text: "Confirm and submit",
                        type: submit,
                        value: 'confirm-and-submit',
                        preventDoubleClick: true,
                        attributes: { 'data-qa': 'submit-to-nomis' }
                    }) }}
                </form>
                <p class="govuk-body govuk-!-font-size-16">
                    <a class="govuk-link" href={{ "/calculation/" + model.prisonerDetail.offenderNo +
                    "/check-information" }}>Cancel calculation</a>
                </p>
            {% endif %}
        </div>
    </div>
{% endblock %}